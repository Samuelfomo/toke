<!doctype html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title></title>
    <meta name="generator" content="LibreOffice 24.8.4.2 (MacOSX)" />
    <meta name="created" content="00:00:00" />
    <meta name="changed" content="2025-09-18T15:36:20.509148376" />
    <style type="text/css">
      @page {
        size: 21cm 29.7cm;
        margin: 2cm;
      }
      p {
        line-height: 115%;
        margin-bottom: 0.25cm;
        background: transparent;
      }
      pre {
        font-family: 'Liberation Mono', monospace;
        font-size: 10pt;
        background: transparent;
      }
      a:link {
        color: #000080;
        text-decoration: underline;
      }
      a:visited {
        color: #800000;
        text-decoration: underline;
      }
    </style>
  </head>
  <body lang="en-GB" link="#000080" vlink="#800000" dir="ltr">
    <pre
      lang="fr-FR"
      style="line-height: 150%; text-align: justify"
    ><font size="3" style="font-size: 12pt"># üìã TOK√â - PR√âSENTATION DU POINTAGE EMPLOY√â</font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">&gt; **Document de R√©f√©rence Technique v2.0**  </span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">&gt; **Syst√®me de Pointage 100% Smartphone pour l'Afrique Centrale**  </span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">&gt; **Architecture Unifi√©e - Sessions de Travail - Anti-Fraude Int√©gr√©**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">---</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">## üéØ CONCEPT G√âN√âRAL</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üì± Vision Produit</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">**Tok√© transforme le smartphone en badgeuse universelle** permettant aux employ√©s de pointer leur pr√©sence via QR Code + GPS, avec une approche **&quot;cancre-proof&quot;** adapt√©e au march√© africain.</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üîë Principe Fondamental : **SESSIONS DE POINTAGE**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">Contrairement aux syst√®mes traditionnels bas√©s sur des &quot;journ√©es&quot;, Tok√© g√®re des **sessions de travail** :</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Session = Clock-in ‚Üí Clock-out** avec pauses optionnelles entre</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Un employ√© = Une session active maximum** (coh√©rence garantie)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Calculs automatiques** dur√©es travail/pause par session</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Gestion chevauchements** jour/nuit (gardes, √©quipes de nuit)</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üõ°Ô∏è S√©curit√© Anti-Fraude</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **QR Code + GPS obligatoires** : Double validation pr√©sence</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **G√©ofencing intelligent** : Polygones complexes par site</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **D√©tection patterns suspects** : Vitesse, doublons, incoh√©rences</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Audit trail complet** : Tra√ßabilit√© l√©gale toute modification</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">---</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">## üë• ACTEURS &amp; R√îLES</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üèóÔ∏è Architecture Utilisateurs Unifi√©e</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">Tok√© utilise une **table `users` unique** avec syst√®me de **r√¥les flexibles** pour supporter tous cas organisationnels.</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### üìã **R√¥les Syst√®me Pr√©d√©finis**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">| R√¥le | Code | Permissions | Cas d'Usage |</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">|------|------|-------------|-------------|</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">| **Employ√©** | `EMPLOYEE` | ‚Ä¢ Pointage&lt;br/&gt;‚Ä¢ Cr√©ation m√©mos&lt;br/&gt;‚Ä¢ Consultation historique personnel | Ouvriers, secr√©taires, techniciens |</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">| **Manager** | `MANAGER` | ‚Ä¢ Pointage personnel&lt;br/&gt;‚Ä¢ Gestion √©quipe&lt;br/&gt;‚Ä¢ Validation m√©mos&lt;br/&gt;‚Ä¢ Cr√©ation sites/QR | Chefs d'√©quipe, responsables service |</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">| **Manager Senior** | `MANAGER_SENIOR` | ‚Ä¢ Toutes permissions Manager&lt;br/&gt;‚Ä¢ Supervision managers&lt;br/&gt;‚Ä¢ Escalade m√©mos&lt;br/&gt;‚Ä¢ Analytics avanc√©es | Directeurs, responsables r√©gion |</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">| **Admin RH** | `HR_ADMIN` | ‚Ä¢ Acc√®s tenant complet&lt;br/&gt;‚Ä¢ Gestion utilisateurs&lt;br/&gt;‚Ä¢ Configuration syst√®me | Service RH, comptabilit√© |</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">| **Auditeur** | `AUDITOR` | ‚Ä¢ Pointage multi-sites&lt;br/&gt;‚Ä¢ Rapports audit&lt;br/&gt;‚Ä¢ Missions temporaires | Contr√¥leurs, inspecteurs |</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### üîÑ **Combinaisons de R√¥les** (Multi-R√¥les)</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">Exemple : Pierre = Chef Chantier</span></font>
‚îú‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">R√¥le MANAGER : G√®re 8 ouvriers + cr√©e QR Chantier Nord</span></font>
‚îî‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">R√¥le EMPLOYEE : Pointe ses propres heures + manager = Directeur Travaux</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">Exemple : Sophie = Responsable R√©gion  </span></font>
‚îú‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">R√¥le MANAGER_SENIOR : Supervise 3 chefs d'agence</span></font>
‚îî‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">R√¥le EMPLOYEE : Employ√©e du Directeur National</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üè¢ **Hi√©rarchie Organisationnelle**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">**Structure Flexible N-Niveaux** via table `org_hierarchy` :</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">TENANT : BATIX SARL</span></font>
‚îÇ
‚îú‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">Directeur G√©n√©ral (HR_ADMIN + MANAGER_SENIOR)</span></font>
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">Directeur Travaux (MANAGER_SENIOR + EMPLOYEE)</span></font>
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">Chef Chantier Nord (MANAGER + EMPLOYEE)</span></font>
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">Ouvrier 1 (EMPLOYEE)</span></font>
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">Ouvrier 2 (EMPLOYEE)  </span></font>
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">Ouvrier 3 (EMPLOYEE)</span></font>
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">Chef Chantier Sud (MANAGER + EMPLOYEE)</span></font>
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">Ouvrier 4 (EMPLOYEE)</span></font>
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">Ouvrier 5 (EMPLOYEE)</span></font>
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">Responsable Bureau (MANAGER + EMPLOYEE)</span></font>
‚îÇ       ‚îú‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">Secr√©taire (EMPLOYEE)</span></font>
‚îÇ       ‚îú‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">Comptable (EMPLOYEE)</span></font>
‚îÇ       ‚îî‚îÄ‚îÄ <font size="3" style="font-size: 12pt"><span lang="fr-FR">Auditeur Mobile (AUDITOR + EMPLOYEE)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">---</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">## üèóÔ∏è MODULES &amp; FONCTIONNALIT√âS</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üì± **Module Pointage Core**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **1. Authentification Diff√©renci√©e**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **OTP Onboarding** : Code 6 chiffres temporaire (premi√®re connexion)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **PIN Employ√©** : 4 chiffres + biom√©trie (usage quotidien pointage)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Password Manager** : Email + mot de passe (gestion √©quipe)</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **2. Types de Pointage**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">| Type | Description | Impact Session | G√©ofencing |</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">|------|-------------|----------------|------------|</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">| `clock_in` | Ouverture session travail | Cr√©e nouvelle session | Obligatoire |</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">| `clock_out` | Fermeture session travail | Ferme session active | Obligatoire |</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">| `pause_start` | D√©but pause (d√©jeuner, etc.) | Session reste ouverte | Obligatoire |</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">| `pause_end` | Fin pause | Session reste ouverte | Obligatoire |</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">| `external_mission` | Mission externe site | Session reste ouverte | Flexibilit√© GPS |</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **3. Gestion Sites Flexible**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Manager Sites** : QR personnel manager (√©quipe d√©di√©e)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Global Sites** : Sites partag√©s (agences, bureaux communs)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Temporary Sites** : Missions temporaires, chantiers courts</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Public Sites** : Gares, a√©roports (cas auditeurs/commerciaux)</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üîÑ **Module Synchronisation Offline**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **Architecture Offline-First**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Stockage local SQLite** : Pointages en attente sync</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Conflict resolution** : Timestamp serveur prime</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Batch synchronisation** : Upload multiple pointages offline</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Auto-retry intelligent** : Exponential backoff r√©seau instable</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **Gestion Conflits**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">Sc√©nario Conflit :</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">1. Employ√© pointe offline 8h00</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">2. Manager corrige online 8h15  </span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">3. Sync employ√© : d√©tection conflit</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">4. R√©solution auto si &lt;30min, sinon m√©mo review manager</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üìù **Module M√©mos &amp; Justifications**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **Types de M√©mos**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Pr√©ventifs** : &quot;Demain retard rdv m√©dical&quot; (avant incident)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Correctifs** : &quot;Oubli pointage sortie hier 17h&quot; (apr√®s incident)  </span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Auto-g√©n√©r√©s** : Syst√®me d√©tecte incoh√©rence ‚Üí m√©mo automatique</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **Workflow Validation**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">Employ√© cr√©e m√©mo ‚Üí Manager validation (24h) ‚Üí [Valid√©/Rejet√©]</span></font>
                    ‚Üì <font size="3" style="font-size: 12pt"><span lang="fr-FR">(si d√©lai d√©pass√©)</span></font>
                  <font size="3" style="font-size: 12pt"><span lang="fr-FR">Escalade N+1 automatique</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **Pi√®ces Jointes**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Photos** : Justificatifs, tickets transport (max 5MB)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Audio** : Explications 30s max (fran√ßais local)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **M√©tadonn√©es** : GPS cr√©ation, device info, timestamp l√©gal</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üö® **Module Anti-Fraude**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **D√©tections Automatiques**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **G√©ofencing violation** : Pointage hors zone autoris√©e</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Doublons temporels** : &lt;15min m√™me site m√™me employ√©</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Vitesse impossible** : D√©placement irr√©aliste entre sites</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **GPS spoofing** : Mock location Android d√©tect√©e</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Patterns suspects** : Comportements r√©currents anormaux</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **Niveaux d'Alerte**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Low** : Logs syst√®me, pas de notification</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Medium** : Notification manager delayed</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **High** : Notification manager imm√©diate  </span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Critical** : Blocage pointage + investigation manuelle</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">---</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">## üîÑ WORKFLOWS D√âTAILL√âS</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üìã **Workflow 1 : Onboarding Employ√©**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">```mermaid</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">sequenceDiagram</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">participant M as Manager (App Manager)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">participant S as Serveur Tok√©</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">participant E as Employ√© (App Pointage)</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">M-&gt;&gt;S: Ajout employ√© + g√©n√©ration OTP</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;E: SMS/WhatsApp OTP (847392)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">E-&gt;&gt;S: Installation app + saisie OTP</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;E: Authentification + liaison manager</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">E-&gt;&gt;E: Configuration PIN local + biom√©trie</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">E-&gt;&gt;S: Premier pointage test</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;M: Notification employ√© actif</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### ‚è∞ **Workflow 2 : Session Pointage Standard**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">```mermaid</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">sequenceDiagram</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">participant E as Employ√©</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">participant A as App Pointage</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">participant S as Serveur</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">participant M as Manager</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">Note over E,M: Matin√©e - Arriv√©e Chantier</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">E-&gt;&gt;A: Ouvre app (PIN/Touch)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">A-&gt;&gt;A: Scan QR Code site</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">A-&gt;&gt;S: POST /pointage (clock_in + GPS)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;S: Validation g√©ofencing + cr√©ation session</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;A: ‚úÖ Session ouverte 8h15</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;M: üì± Notification arriv√©e Pierre</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">Note over E,M: Midi - Pause D√©jeuner  </span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">E-&gt;&gt;A: Bouton &quot;Pause D√©j&quot;</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">A-&gt;&gt;S: POST /pointage (pause_start)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;A: ‚úÖ Pause d√©but√©e 12h00</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">Note over E,M: 13h30 - Reprise Travail</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">E-&gt;&gt;A: Bouton &quot;Reprendre&quot;  </span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">A-&gt;&gt;S: POST /pointage (pause_end)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;A: ‚úÖ Travail repris 13h32</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">Note over E,M: Soir - D√©part</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">E-&gt;&gt;A: Scan QR Code site</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">A-&gt;&gt;S: POST /pointage (clock_out + GPS)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;S: Fermeture session + calcul dur√©es</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;A: üè† Session ferm√©e - 8h58 travaill√©es</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;M: üìä Rapport journ√©e Pierre</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üö® **Workflow 3 : Gestion Exception**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">```mermaid</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">sequenceDiagram</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">participant E as Employ√©</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">participant A as App Pointage  </span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">participant S as Serveur</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">participant M as Manager</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">Note over E,M: Sc√©nario : Employ√© oublie clock-out hier</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">E-&gt;&gt;A: Tentative clock-in ce matin</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">A-&gt;&gt;S: POST /pointage (clock_in)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;S: ‚ö†Ô∏è D√©tection session non ferm√©e</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;S: Auto-fermeture session pr√©c√©dente</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;S: Cr√©ation m√©mo automatique</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;A: ‚úÖ Nouveau clock-in + ‚ö†Ô∏è M√©mo cr√©√©</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;M: üìù M√©mo auto &quot;Session non ferm√©e&quot;</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">Note over M: Manager traite m√©mo</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">M-&gt;&gt;S: Validation m√©mo</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;E: üì± M√©mo valid√©</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;S: Correction donn√©es pointage</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üîÑ **Workflow 4 : Synchronisation Offline**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">```mermaid</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">sequenceDiagram</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">participant E as Employ√©</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">participant L as SQLite Local</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">participant A as App Pointage</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">participant S as Serveur</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">Note over E,S: Mode Offline (pas de r√©seau)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">E-&gt;&gt;A: Pointages multiples</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">A-&gt;&gt;L: Stockage local s√©curis√©</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">L-&gt;&gt;A: Queue sync (3 pointages en attente)</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">Note over E,S: Connexion r√©cup√©r√©e</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">A-&gt;&gt;A: D√©tection r√©seau</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">A-&gt;&gt;S: POST /pointage/batch (3 pointages)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;S: Traitement s√©quentiel + validation</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">S-&gt;&gt;A: R√©sultats : 2 ‚úÖ / 1 ‚ùå (conflit)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">A-&gt;&gt;L: Nettoyage donn√©es synchronis√©es</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">A-&gt;&gt;E: üì± Sync termin√©e - 1 conflit √† r√©soudre</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">---</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">## üóÑÔ∏è STRUCTURE TABLES SQL</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üìä **Tables Core Syst√®me**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **1. Utilisateurs Unifi√©s**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Table principale : tous utilisateurs (managers + employ√©s)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE TABLE users (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">id SERIAL PRIMARY KEY,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">user_guid UUID UNIQUE NOT NULL DEFAULT gen_random_uuid(),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">tenant_id INTEGER REFERENCES tenants(id) ON DELETE CASCADE,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Informations personnelles</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">email VARCHAR(255) UNIQUE,          -- Obligatoire si manager</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">first_name VARCHAR(100) NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">last_name VARCHAR(100) NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">phone_number VARCHAR(20) UNIQUE,    -- Obligatoire si employ√©</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">employee_code VARCHAR(20) UNIQUE,   -- Auto-g√©n√©r√© si employ√©</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Authentification diff√©renci√©e</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">pin_hash VARCHAR(255),              -- PIN employ√© (pointage)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">password_hash VARCHAR(255),         -- Password manager (gestion)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">otp_token VARCHAR(10),              -- OTP temporaire onboarding</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">otp_expires_at TIMESTAMPTZ,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- QR Code personnel (si manager)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">qr_code_token VARCHAR(255) UNIQUE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">qr_code_expires_at TIMESTAMPTZ,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- M√©tadonn√©es</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">avatar_url TEXT,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">hire_date DATE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">department VARCHAR(100),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">job_title VARCHAR(100),</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Statuts</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">is_active BOOLEAN DEFAULT TRUE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">last_login_at TIMESTAMPTZ,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">created_at TIMESTAMPTZ DEFAULT NOW(),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">updated_at TIMESTAMPTZ DEFAULT NOW()</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **2. Syst√®me de R√¥les**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- R√¥les syst√®me (permissions granulaires)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE TABLE roles (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">id SERIAL PRIMARY KEY,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">role_code VARCHAR(50) UNIQUE NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">role_name VARCHAR(100) NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">description TEXT,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">permissions JSONB NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">is_system_role BOOLEAN DEFAULT TRUE</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Attribution r√¥les aux utilisateurs (many-to-many)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE TABLE user_roles (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">id SERIAL PRIMARY KEY,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">role_id INTEGER REFERENCES roles(id) ON DELETE CASCADE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">assigned_at TIMESTAMPTZ DEFAULT NOW(),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">assigned_by INTEGER REFERENCES users(id),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">UNIQUE(user_id, role_id)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **3. Hi√©rarchie Organisationnelle**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Relations hi√©rarchiques (n-levels, flexible)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE TABLE org_hierarchy (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">id SERIAL PRIMARY KEY,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">subordinate_id INTEGER REFERENCES users(id) ON DELETE CASCADE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">supervisor_id INTEGER REFERENCES users(id) ON DELETE CASCADE,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- M√©tadonn√©es relation</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">relationship_type VARCHAR(50) DEFAULT 'direct_report',</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">effective_from DATE NOT NULL DEFAULT CURRENT_DATE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">effective_to DATE, -- NULL = relation active</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Contexte organisationnel</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">department VARCHAR(100),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">cost_center VARCHAR(50),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">delegation_level INTEGER DEFAULT 1,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">created_at TIMESTAMPTZ DEFAULT NOW(),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">UNIQUE(subordinate_id, supervisor_id, effective_from)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üè¢ **Tables Sites &amp; G√©olocalisation**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **4. Sites de Travail**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE TABLE sites (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">id SERIAL PRIMARY KEY,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">site_guid UUID UNIQUE NOT NULL DEFAULT gen_random_uuid(),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">tenant_id INTEGER REFERENCES tenants(id) ON DELETE CASCADE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">created_by_user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Informations site</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">site_name VARCHAR(255) NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">site_type site_type NOT NULL DEFAULT 'manager_site',</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">address TEXT,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- G√©ofencing (polygone complexe GeoJSON)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">geofence_polygon JSONB NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">geofence_radius INTEGER DEFAULT 100,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- QR Code &amp; autorisations</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">qr_reference_user_id INTEGER REFERENCES users(id),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">qr_code_data JSONB NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">is_active BOOLEAN DEFAULT TRUE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">is_public BOOLEAN DEFAULT FALSE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">allowed_roles JSONB,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">created_at TIMESTAMPTZ DEFAULT NOW(),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">updated_at TIMESTAMPTZ DEFAULT NOW()</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Types de sites</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE TYPE site_type AS ENUM (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'manager_site',     -- Site cr√©√© par manager</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'global_site',      -- Site partag√©</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'temporary_site',   -- Mission temporaire</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'public_site'       -- Acc√®s libre (gares, etc.)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### ‚è∞ **Tables Pointages &amp; Sessions**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **5. Sessions de Travail**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Sessions de travail (concept central)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE TABLE work_sessions (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">id SERIAL PRIMARY KEY,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">session_guid UUID UNIQUE NOT NULL DEFAULT gen_random_uuid(),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">site_id INTEGER REFERENCES sites(id) ON DELETE CASCADE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">session_status session_status DEFAULT 'open',</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Timestamps session</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">session_start_at TIMESTAMPTZ NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">session_end_at TIMESTAMPTZ,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Calculs automatiques</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">total_work_duration INTERVAL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">total_pause_duration INTERVAL,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- G√©olocalisation</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">start_latitude DECIMAL(10,8),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">start_longitude DECIMAL(11,8),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">end_latitude DECIMAL(10,8),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">end_longitude DECIMAL(11,8),</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Justification li√©e</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">memo_id INTEGER REFERENCES memos(id) ON DELETE SET NULL,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">created_at TIMESTAMPTZ DEFAULT NOW(),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">updated_at TIMESTAMPTZ DEFAULT NOW()</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Statuts de session</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE TYPE session_status AS ENUM (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'open',         -- Session en cours</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'closed',       -- Ferm√©e normalement</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'abandoned',    -- Non ferm√©e (oubli)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'corrected'     -- Corrig√©e manuellement</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Partitionnement par mois (performance)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Cr√©√© automatiquement par fonction maintenance</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **6. Pointages Individuels**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Pointages individuels (actions dans sessions)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE TABLE time_entries (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">id SERIAL PRIMARY KEY,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">entry_guid UUID UNIQUE NOT NULL DEFAULT gen_random_uuid(),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">session_id INTEGER REFERENCES work_sessions(id) ON DELETE CASCADE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">site_id INTEGER REFERENCES sites(id) ON DELETE CASCADE,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Type et statut pointage</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">pointage_type pointage_type NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">pointage_status pointage_status DEFAULT 'pending',</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Timestamps (d√©clar√© vs r√©el si correction)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">clocked_at TIMESTAMPTZ NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">real_clocked_at TIMESTAMPTZ,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">server_received_at TIMESTAMPTZ DEFAULT NOW(),</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- G√©olocalisation obligatoire</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">latitude DECIMAL(10,8) NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">longitude DECIMAL(11,8) NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">gps_accuracy INTEGER,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- M√©tadonn√©es device (anti-fraude)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">device_info JSONB,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">ip_address INET,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">user_agent TEXT,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Gestion offline/sync</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">created_offline BOOLEAN DEFAULT FALSE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">local_id VARCHAR(50),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">sync_attempts INTEGER DEFAULT 0,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">last_sync_attempt TIMESTAMPTZ,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Justification</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">memo_id INTEGER REFERENCES memos(id) ON DELETE SET NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">correction_reason TEXT,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">created_at TIMESTAMPTZ DEFAULT NOW(),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">updated_at TIMESTAMPTZ DEFAULT NOW()</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Types de pointage</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE TYPE pointage_type AS ENUM (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'clock_in',         -- Ouverture session</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'clock_out',        -- Fermeture session</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'pause_start',      -- D√©but pause</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'pause_end',        -- Fin pause</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'external_mission'  -- Mission externe</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Statuts pointage</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE TYPE pointage_status AS ENUM (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'draft',        -- Cr√©√© offline</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'pending',      -- En attente validation</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'accepted',     -- Valid√© automatiquement</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'corrected',    -- Corrig√© par manager</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'accounted',    -- Pris en compte paie</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'rejected'      -- Rejet√© (fraude)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üìù **Tables M√©mos &amp; Justifications**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **7. M√©mos**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- M√©mos (justifications employ√©s/managers)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE TABLE memos (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">id SERIAL PRIMARY KEY,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">memo_guid UUID UNIQUE NOT NULL DEFAULT gen_random_uuid(),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">author_user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">target_user_id INTEGER REFERENCES users(id) ON DELETE CASCADE, -- Si diff√©rent auteur</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">validator_user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Contenu m√©mo</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">memo_type memo_type NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">memo_status memo_status DEFAULT 'draft',</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">title VARCHAR(200) NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">description TEXT NOT NULL,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Incident concern√©</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">incident_datetime TIMESTAMPTZ,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">affected_session_id INTEGER REFERENCES work_sessions(id),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">affected_entries_ids INTEGER[], -- Array IDs pointages concern√©s</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Pi√®ces jointes (URLs sign√©es)</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">attachments JSONB,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Traitement</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">validator_comments TEXT,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">processed_at TIMESTAMPTZ,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Auto-g√©n√©ration</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">auto_generated BOOLEAN DEFAULT FALSE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">auto_reason VARCHAR(255),</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">created_at TIMESTAMPTZ DEFAULT NOW(),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">updated_at TIMESTAMPTZ DEFAULT NOW()</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Types de m√©mos</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE TYPE memo_type AS ENUM (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'delay_justification',      -- Retard expliqu√©</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'absence_justification',    -- Absence expliqu√©e</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'correction_request',       -- Demande correction</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'session_closure',          -- Fermeture oubli√©e</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'auto_generated'            -- M√©mo automatique</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Statuts m√©mos</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE TYPE memo_status AS ENUM (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'draft',        -- Brouillon local</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'submitted',    -- Soumis validateur</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'pending',      -- En attente traitement</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'approved',     -- Approuv√©</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">'rejected'      -- Rejet√©</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üîç **Tables Audit &amp; S√©curit√©**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **8. Audit Trail**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Logs d'audit (toute modification trac√©e)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE TABLE audit_logs (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">id SERIAL PRIMARY KEY,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">table_name VARCHAR(50) NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">record_id INTEGER NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">record_guid UUID,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">operation VARCHAR(10) NOT NULL, -- INSERT, UPDATE, DELETE</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">old_values JSONB,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">new_values JSONB,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">changed_by_user_id INTEGER,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">changed_by_type VARCHAR(20), -- 'user', 'system', 'api'</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">change_reason TEXT,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">ip_address INET,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">user_agent TEXT,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">created_at TIMESTAMPTZ DEFAULT NOW()</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **9. D√©tection Fraude**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Alertes fraude &amp; anomalies</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE TABLE fraud_alerts (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">id SERIAL PRIMARY KEY,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">alert_guid UUID UNIQUE NOT NULL DEFAULT gen_random_uuid(),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">time_entry_id INTEGER REFERENCES time_entries(id) ON DELETE CASCADE,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">alert_type VARCHAR(50) NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">alert_severity VARCHAR(20) DEFAULT 'medium',</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">alert_description TEXT NOT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">alert_data JSONB, -- Donn√©es d√©taill√©es</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">is_investigated BOOLEAN DEFAULT FALSE,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">investigation_notes TEXT,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">is_false_positive BOOLEAN DEFAULT FALSE,</span></font>
    
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">created_at TIMESTAMPTZ DEFAULT NOW(),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">investigated_at TIMESTAMPTZ</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üìà **Index &amp; Performance**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **Index Principaux**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Index utilisateurs</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_users_tenant_id ON users(tenant_id);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_users_phone ON users(phone_number);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_users_email ON users(email);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_users_employee_code ON users(employee_code);</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Index hi√©rarchie</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_org_hierarchy_subordinate ON org_hierarchy(subordinate_id);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_org_hierarchy_supervisor ON org_hierarchy(supervisor_id);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_org_hierarchy_active ON org_hierarchy(supervisor_id, subordinate_id) </span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">WHERE effective_to IS NULL;</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Index sessions (requ√™tes fr√©quentes)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_work_sessions_user_id ON work_sessions(user_id);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_work_sessions_site_id ON work_sessions(site_id);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_work_sessions_status ON work_sessions(session_status);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_work_sessions_start_date ON work_sessions(session_start_at);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_work_sessions_user_start ON work_sessions(user_id, session_start_at DESC);</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Index pointages (volume important)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_time_entries_session_id ON time_entries(session_id);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_time_entries_user_id ON time_entries(user_id);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_time_entries_site_id ON time_entries(site_id);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_time_entries_clocked_at ON time_entries(clocked_at);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_time_entries_status ON time_entries(pointage_status);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_time_entries_user_date ON time_entries(user_id, clocked_at DESC);</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Index g√©ospatial (g√©ofencing)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_time_entries_location ON time_entries </span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">USING GIST(ST_Point(longitude, latitude));</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_sites_geofence ON sites USING GIN(geofence_polygon);</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Index m√©mos</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_memos_author_user_id ON memos(author_user_id);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_memos_validator_user_id ON memos(validator_user_id);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_memos_status ON memos(memo_status);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_memos_type ON memos(memo_type);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE INDEX idx_memos_session_id ON memos(affected_session_id);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **Contraintes M√©tier**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Un utilisateur ne peut avoir qu'une session ouverte</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE UNIQUE INDEX idx_unique_open_session </span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">ON work_sessions(user_id) </span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">WHERE session_status = 'open';</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- Pointage offline unique par local_id</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE UNIQUE INDEX idx_unique_offline_entry</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">ON time_entries(user_id, local_id)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">WHERE local_id IS NOT NULL;</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- QR code manager unique</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE UNIQUE INDEX idx_unique_manager_qr </span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">ON users(qr_code_token) </span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">WHERE qr_code_token IS NOT NULL;</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">-- OTP temporaire unique actif</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE UNIQUE INDEX idx_unique_active_otp</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">ON users(otp_token)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">WHERE otp_token IS NOT NULL AND otp_expires_at &gt; NOW();</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">---</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">## üîß FONCTIONS M√âTIER CL√âS</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üìã **Proc√©dures Pointage**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **1. Authentification Employ√©**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE OR REPLACE FUNCTION authenticate_user(</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">p_otp VARCHAR(10) DEFAULT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">p_phone VARCHAR(20) DEFAULT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">p_pin_hash VARCHAR(255) DEFAULT NULL</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">) RETURNS TABLE (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">user_guid UUID,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">employee_code VARCHAR(20),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">full_name TEXT,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">roles TEXT[],</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">tenant_guid UUID,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">is_first_login BOOLEAN</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **2. Traitement Pointage**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE OR REPLACE FUNCTION process_pointage(</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">p_user_guid UUID,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">p_site_guid UUID,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">p_pointage_type pointage_type,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">p_clocked_at TIMESTAMPTZ,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">p_latitude DECIMAL(10,8),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">p_longitude DECIMAL(11,8),</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">p_device_info JSONB DEFAULT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">p_local_id VARCHAR(50) DEFAULT NULL,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">p_created_offline BOOLEAN DEFAULT FALSE</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">) RETURNS TABLE (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">success BOOLEAN,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">entry_guid UUID,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">session_guid UUID,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">message TEXT,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">auto_memo_created BOOLEAN</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **3. Synchronisation Batch**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE OR REPLACE FUNCTION process_batch_pointages(</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">p_user_guid UUID,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">p_pointages JSONB -- Array pointages offline</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">) RETURNS TABLE (</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">processed_count INTEGER,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">success_count INTEGER,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">error_count INTEGER,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">results JSONB</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üè¢ **Fonctions Hi√©rarchie**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **4. R√©cup√©ration Subordin√©s R√©cursive**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE OR REPLACE FUNCTION get_all_subordinates(p_supervisor_id INTEGER)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">RETURNS TABLE(</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">subordinate_id INTEGER,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">subordinate_guid UUID,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">full_name TEXT,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">level_depth INTEGER,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">relationship_path TEXT[]</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">);</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **5. Validation Autorisation Site**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE OR REPLACE FUNCTION can_user_point_at_site(</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">p_user_id INTEGER,</span></font>
    <font size="3" style="font-size: 12pt"><span lang="fr-FR">p_site_id INTEGER</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">) RETURNS BOOLEAN;</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **6. R√©solution Validateur M√©mo**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```sql</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">CREATE OR REPLACE FUNCTION get_memo_validator(p_user_id INTEGER)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">RETURNS INTEGER;</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">```</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">---</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">## üéØ POINTS CL√âS ARCHITECTURE</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### ‚úÖ **Avantages Syst√®me**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **Flexibilit√© Organisationnelle**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Multi-r√¥les** : Manager qui pointe ses propres heures</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Hi√©rarchie n-niveaux** : Support organisations complexes</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Sites adaptatifs** : Manager, global, temporaire, public</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **D√©l√©gations** : Missions, int√©rims, restructurations</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **Robustesse Technique** </span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Sessions coh√©rentes** : Impossible d'√™tre &quot;point√©&quot; sans contr√¥le</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Offline-first** : Fonctionne 7 jours sans connexion</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Anti-fraude int√©gr√©** : GPS + QR + patterns analysis</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Audit trail complet** : Conformit√© l√©gale Cameroun</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **Performance Optimis√©e**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Partitionnement** : Tables pointages par mois</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Indexation** : Requ√™tes sub-seconde m√™me gros volumes</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Batch processing** : Sync offline intelligente</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Cache strat√©gique** : Sites fr√©quents, hi√©rarchie</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üöÄ **√âvolutivit√© Future**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **Int√©grations Pr√©vues**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **SIRH existants** : Sage, Cegid, SAP (APIs standard)</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Biom√©trie** : Empreintes, reconnaissance faciale</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **IoT Hybride** : Badgeuses + QR + biom√©trie </span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Analytics IA** : D√©tection fraude sophistiqu√©e</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">#### **Multi-Pays**</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Timezone dynamique** : TIMESTAMPTZ partout</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Conformit√© l√©gale** : Horodatage selon pays</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Multi-devises** : Calculs paie localis√©s</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Langues** : i18n fran√ßais/anglais/arabe</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">---</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">## üìã CONCLUSION</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üéØ **Syst√®me Complet &amp; √âvolutif**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">Le syst√®me de pointage employ√© Tok√© offre une **architecture unifi√©e robuste** qui :</span></font>

‚úÖ <font size="3" style="font-size: 12pt"><span lang="fr-FR">**R√©pond aux besoins m√©tier** : Tous types d'organisations, de l'artisan √† la multinationale  </span></font>
‚úÖ <font size="3" style="font-size: 12pt"><span lang="fr-FR">**Garantit la s√©curit√©** : Anti-fraude multi-couches, audit trail complet  </span></font>
‚úÖ <font size="3" style="font-size: 12pt"><span lang="fr-FR">**Assure la performance** : Optimis√© smartphones low-end, offline-first  </span></font>
‚úÖ <font size="3" style="font-size: 12pt"><span lang="fr-FR">**Facilite l'√©volution** : R√¥les flexibles, hi√©rarchie adaptable, int√©grations futures</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">### üöÄ **Pr√™t Production**</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">Cette pr√©sentation constitue la **r√©f√©rence technique compl√®te** pour :</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **√âquipe d√©veloppement** : Structure SQL, fonctions m√©tier, workflows</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Product Owners** : Cas d'usage, acteurs, modules fonctionnels  </span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **Architectes** : D√©cisions techniques, patterns, √©volutivit√©</span></font>
<font size="3" style="font-size: 12pt"><span lang="fr-FR">- **QA/Tests** : Sc√©narios validation, contraintes m√©tier</span></font>

<font size="3" style="font-size: 12pt"><span lang="fr-FR">**Le syst√®me de pointage Tok√© est pr√™t √† r√©volutionner la gestion RH en Afrique centrale ! üéØ**</span></font></pre>
  </body>
</html>
